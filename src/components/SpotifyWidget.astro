<div id="spotify" class="absolute bottom-8 right-8 text-white" style="font-family: Consolas, monospace; font-size: 14px; line-height: 20px;">
	<p class="text-gray-400 mb-2">currently listening to:</p>
	<div id="spotify-content" class="flex items-center gap-3">
		<p class="text-gray-500">loading...</p>
	</div>
</div>

<script>
	const DISCORD_USER_ID = '629344560203431977';
	let ws: WebSocket | null = null;
	let heartbeatInterval: number | null = null;

	function updateDisplay(data: any) {
		const content = document.getElementById('spotify-content');
		if (!content) return;

		const spotify = data.spotify;
		const isListening = data.listening_to_spotify;

		if (spotify && isListening) {
			content.innerHTML = `
				<img src="${spotify.album_art_url}" alt="Album" class="w-12 h-12 object-cover" />
				<div>
					<a href="https://open.spotify.com/track/${spotify.track_id}" target="_blank" class="text-white hover:text-blue-400">
						<p class="font-semibold">${spotify.song}</p>
						<p class="text-gray-400 text-sm">${spotify.artist}</p>
					</a>
				</div>
			`;
		} else {
			content.innerHTML = '<p class="text-gray-500">not playing anything</p>';
		}
	}

	function connectWebSocket() {
		ws = new WebSocket('wss://api.lanyard.rest/socket');

		ws.onopen = () => {
			console.log('Lanyard WebSocket connected');
		};

		ws.onmessage = (event) => {
			const message = JSON.parse(event.data);

			switch (message.op) {
				case 1:
					const heartbeatInterval = message.d.heartbeat_interval;
					setInterval(() => {
						if (ws?.readyState === WebSocket.OPEN) {
							ws.send(JSON.stringify({ op: 3 }));
						}
					}, heartbeatInterval);

					ws?.send(JSON.stringify({
						op: 2,
						d: {
							subscribe_to_id: DISCORD_USER_ID
						}
					}));
					break;

				case 0:
					if (message.t === 'INIT_STATE') {
						updateDisplay(message.d);
					} else if (message.t === 'PRESENCE_UPDATE') {
						updateDisplay(message.d);
					}
					break;
			}
		};

		ws.onerror = (error) => {
			console.error('Lanyard WebSocket error:', error);
		};

		ws.onclose = () => {
			console.log('Lanyard WebSocket closed, reconnecting in 5s...');
			setTimeout(connectWebSocket, 5000);
		};
	}

	connectWebSocket();
</script>
